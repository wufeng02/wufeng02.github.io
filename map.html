<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width" />

    <meta name="robots" content="NOINDEX, NOFOLLOW"/>

    <title>Feng Wu (吴锋) | Map</title>
    <style>
      .map {
		position: absolute;
		top: 0px; 
        left: 0px;
		width: 100%; 
        height: 100%;
      }
    </style>
    <script src="http://cache.amap.com/lbs/static/es5.min.js" type="text/javascript"></script>
    <script src="http://webapi.amap.com/maps?v=1.3&key=619bcf3ce4b1077fc647330ac38ba52c" type="text/javascript"></script>
  </head>
  <body>
    <div id="map" class="map"></div>
    <script type="text/javascript">
      var options = { 
        markers: []
      };

      var search = window.location.search.substring(1);
      if (search) {
        var a = search.split('&'), b, c, d;
        for (var i = 0; i < a.length; ++i) {
            if (!a[i]) continue;
            var b = a[i].split('=');
            if (!b[0] || !b[1]) continue;
            switch (b[0]) {
            case 'center':
                c = b[1].split(',');
                options['center'] = [
                    parseFloat(c[0]), parseFloat(c[1])];
                break;
            case 'zoom':
                options['zoom'] = parseInt(b[1]);
                break;
            case 'markers':
                c = b[1].split('|');
                for (var j = 0; j < c.length; ++j) {
                    if (!c[j]) continue;
                    d = c[j].split(',');
                    options['markers'].push({
                        position: [parseFloat(d[0]), parseFloat(d[1])]
                    });
                }
                break;
            }
        }
      }
    
      var map = new AMap.Map('map', {
        lang: 'zh_en',
        resizeEnable: true,
        rotateEnable: true,
        zoom: options['zoom'],
        center: options['center']
      });

      map.plugin(['AMap.Scale', 'AMap.ToolBar', 'AMap.MapType', 'AMap.Geolocation'], function() {
        map.addControl(new AMap.Scale());
        map.addControl(new AMap.ToolBar());
        map.addControl(new AMap.MapType());
        map.addControl(new AMap.Geolocation({
            buttonPosition: 'RT', /*************/
            buttonOffset: new AMap.Pixel(27, 120)
        }));
      });

      var infoWindow = new AMap.InfoWindow({
        offset: new AMap.Pixel(0, -30)
      });

      var markers = [];
      options['markers'].forEach(function(option) {
        var marker = new AMap.Marker({
            map: map,
            clickable: true,
            draggable: true,
            raiseOnDrag: true,
            position: option.position
        });
        marker.on('click', function() {
            var position = marker.getPosition();
            infoWindow.setContent(position.toString());
            infoWindow.open(map, position);
        });
        markers.push(marker);
      });

      var update_link = true;
      function permalink() {
        if (!update_link) {
            update_link = true;
            return;
        }

        var search = '?center=' + map.getCenter() +
            '&zoom=' + map.getZoom() + 
            '&markers=';
        markers.forEach(function(marker) {
            search += marker.getPosition() + '|';
        });

        var state = {
            center: map.getCenter(),
            zoom: map.getZoom()
        };
        window.history.pushState(state, 'map', search);
      };
      map.on('moveend', permalink);

      window.addEventListener('popstate', function(e) {
        if (e.state === null) {
            return;
        }
        map.setCenter(e.state.center);
        map.setZoom(e.state.zoom);
        update_link = false;
      });

      map.on('complete', function() {
        //var logo = document.querySelector('.amap-logo');
      });

      map.on('click', function(e) {
        var copyright = document.querySelector('.amap-copyright');
        if (copyright) copyright.innerHTML = 
            e.lnglat.getLng() + ',' + e.lnglat.getLat();
      })
    </script>
  </body>
</html>